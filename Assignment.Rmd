---
title: "Group project"
author: "Eleonora"
date: "2023-09-13"
output:
  pdf_document: default
  html_document: default
  word_document: default
---

**loading libraries**

```{r message=FALSE}
library(tidyverse)
library(lubridate)
library(ggplot2)
library(dplyr)
library(stringr)
```

```{r include=FALSE}
# Custom theme for visualization
library(unikn)
library(ggthemes)

plotly <- usecol(c('#ff7f0e', '#1f77b4', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'))

pitaya <- usecol(c('#ff6e9c98', '#7A76C2', '#18c0c4', '#f62196', '#f3907e', '#66E9EC'))

theme_plotly <- function(){
  theme_fivethirtyeight() %+%
    theme(rect = element_rect(fill = "white"),
          text = element_text(colour = "black"),
          panel.background = element_rect(fill = "#EFECF6"),
          legend.key = element_rect(fill = "#EFECF6"),
          panel.grid.major = element_line(colour = "white"),
          panel.grid.minor = element_blank(),
          axis.title = element_text(colour = "black", size = 12),
          axis.text = element_text(colour = "black", size = 11),
          plot.title = element_text(size = 14, vjust=2, colour = "black"),
          axis.ticks = element_blank(),
          legend.position = "right",
          legend.direction = "vertical")
}
```

**Importing the CSV files**

```{r}
in13 <- read.csv('in13.csv', row.names = 1)
an13 <- read.csv('an13.csv', row.names = 1)
dati1 <- read.csv('dati1.csv', row.names = 1)
```

**Let's get a glimpse about our datasets**

```{r}
# glimpse(in13)
# glimpse(an13)
# glimpse(dati1)
```

# Data cleaning

**Looking for NA values**

```{r}
sum(is.na(in13))
sum(is.na(an13))
sum(is.na(dati1))

# As we can observe, the datasets 'an13' and 'dati1' 
# contains many missing values, while '1n13' has 0 NA.
```

**Now let's analyze each csv singularly:**

##   in13:

```{r}
in13$museo=as.factor(in13$museo)
in13$prov_museo=as.factor(in13$prov_museo)
in13$com_museo=as.factor(in13$com_museo)
in13$datai <- as.Date(in13$datai, "%d/%m/%Y")
in13$orai <- str_sub(in13$orai, end = -4)
in13$orai <- as.integer(in13$orai)

# in13$orai <- as.int
# in13$Date <- paste(in13$datai, in13$orai)
# in13$Date <- strptime(in13$Date, format = "%d/%m/%Y %H:%M")
# colnames(in13)[colnames(in13) == "CodCliente"] <- "codcliente"
# in13 <- subset(in13, select = -c(datai, orai))
```

##   an13:

```{r}
sapply(an13, function(x) sum(is.na(x)))

# The number of NAs in the variable "professione" is equal to the observations, 
# that means that all the "professione" observations are NAs, so we remove them.

# As we can see, all the remaining Nas are from the variable sex, other variables
# have data different from NA.
```
```{r}
an13$professione <- NULL
```

```{r}
sum(an13$comune == "DATO MANCANTE")

# Let's remove the missing data from the people without a "comune" variable

# an13$comune <- an13[!(an13$comune == "DATO MANCANTE"),]
```

```{r}
sum(an13$cap == "XXXXX")

# an13$cap <- an13[!(an13$cap == "XXXXX"),]
```

```{r}
an13$data_inizio <- str_sub(an13$data_inizio, end = -7) # remove hours and minutes
# an13$data_inizio <- strptime(an13$data_inizio, format = "%d/%m/%Y %H:%M")
an13$data_inizio <- as.Date(an13$data_inizio, "%d/%m/%Y")
an13$sesso <- as.factor(an13$sesso)
an13$data_nascita <- as.integer(an13$data_nascita)
an13$sconto <- as.factor(an13$sconto)
an13$riduzione <- as.factor(an13$riduzione)
an13$tipo_pag <- as.factor(an13$tipo_pag)
an13$agenzia <- as.factor(an13$agenzia)
an13$agenzia_tipo <- as.factor(an13$agenzia_tipo)
an13$comune <- as.factor(an13$comune)
# an13$cap <- as.integer(an13$cap)
an13$nuovo_abb <- as.factor(an13$nuovo_abb)
```

```{r}
sapply(an13, function(x) sum(is.na(x)))

# As we can see, only two observations in "data_nascita" are now NA, that means
# that two observations were incorrect
```


##   dati1:

```{r}
sapply(dati1, function(x) sum(is.na(x)))

# The number of NAs in the variable "sesso" is pretty much the same
# in the an13 dataset, at this point we can assume that most of the
# missing values are the same for both datasets and we can remove them
```

```{r}
dati1$si2013 <- as.factor(dati1$si2013)
dati1$si2014 <- as.factor(dati1$si2014)
dati1$sesso <- as.factor(dati1$sesso)
dati1$cambiocap0512 <- as.factor(dati1$cambiocap0512)
dati1$prov <- as.factor(dati1$prov)

dati1$ultimo_ing.x <- sub( '(?<=.{6})', '20', dati1$ultimo_ing.x, perl=TRUE)
dati1$abb13 <- sub( '(?<=.{6})', '20', dati1$abb13, perl=TRUE)
dati1$abb14 <- sub( '(?<=.{6})', '20', dati1$abb14, perl=TRUE)
```

```{r}
dati1$ultimo_ing.x <- as.Date(dati1$ultimo_ing.x, "%d/%m/%Y")
dati1$abb13 <- as.Date(dati1$abb13, "%d/%m/%Y")
dati1$abb14 <- as.Date(dati1$abb14, "%d/%m/%Y")
```


```{r}
sum(is.na(dati1$nvisite0512))
sum(is.na(dati1$nmusei0512))
# The number of Nas are the same in the two variables, so we can assume that
# having no data correspond to not having visited any museum. We then change
# the Nas to 0
```

```{r}
# dati1["nvisite0512"][is.na(dati1["nvisite0512"])] <- 0
# dati1["nmusei0512"][is.na(dati1["nmusei0512"])] <- 0
```

```{r}
sum(dati1$si2014 == 0)
sum(is.na(dati1$abb14))
# The number of Nas is pretty much the same, so we can assume that customers
# that have churned from the contract have been recorded with NA in the 
# "abb14" variable, so we can change their value to 0
```

```{r}
dati1 <- dati1 %>%
  mutate(abb14 = ifelse(si2014 == 0, 0, abb14))
```

```{r}
sapply(dati1, function(x) sum(is.na(x)))

# Chiedere nvisite0512 e nmusei0512,
# cambiare provincia con comune in an13 relativo al codicecliente, se cambio cap = 0
# ultimo ingresso da vedere
```


**Removing NA**

```{r}
an13 <- na.omit(an13)
dati1 <-  na.omit(dati1)
sum(is.na(an13))
sum(is.na(dati1))
```


# Descriptive Analysis

```{r}
dati1$agegroup <- cut(dati1$eta13, 
                         breaks = c(-Inf, 18, 30, 45, 60, Inf),
                         labels = c("Below 18","18-29",
                                    "30-44","45-59", "60+"),
                         right = FALSE)
```

```{r fig.dim=c(8,6), dpi=200}
ggplot(data = dati1, aes(x = agegroup)) +
  geom_bar(show.legend = FALSE, fill='#1f77b4') +
  geom_text(stat = "count", aes(label = after_stat(count)), vjust =-0.7) +
  expand_limits(y = 23000) +
  theme_plotly()
```

The above bar chart shows the overall age of customers. It is observed that the number of customers is the highest with an amount of 32,237 at age ranged 60+ which is the older crowd. 
From age range of 18-29 onwards the frequency of customers increases steadily as the age increase until age ABOVE 60 where a significantly higher frequency of customers was observed. Customers aged below 18 is the lowest at 2,055, this is probably because the company requires the customers to be at least 18 years old to register as a member. Hence, it explains the low number of customers in this range of age.

```{r fig.dim=c(8,6), dpi=200}
ggplot(dati1, aes(x = si2014, fill=si2014)) +
  geom_bar(show.legend = FALSE) +
  labs(title = "Population of Churners and Non-Churners", x = "Churners", y = "Count") +
  geom_text(stat = "count", aes(label = after_stat(count)), vjust =-0.7) +
  expand_limits(y = 42000) +
  theme_plotly() + scale_fill_manual(values = plotly)
```

Next, shows the population of churners and non-churners. 0 indicates that they are churners while 1 indicates that they are not churners.

```{r}
dati1$frequency13 <- cut(dati1$nvisit13, 
                         breaks = c(-Inf, 2, 5, 10, 20, Inf),
                         labels = c("0-1", "2-5", "5-9","10-19", "20+"),
                         right = FALSE)
```

```{r fig.dim=c(8,6), dpi=200}
ggplot(dati1) +
  aes(x = frequency13, fill = si2014) +
  geom_bar() + theme_plotly() + 
  scale_fill_manual(values = plotly)
```

When comparing Churner vs SpendFrequencyRange (see Figure 4), it is noticeable that most of the churners (yes) SpendFrequencyRange of 1, 2, 3, and 4-10 which means that they have only spent less than 10 times. Looking at SpendFrequencyRange of 1, it is almost a half-half distribution where there is a close number of churners and 
non-churners. This means that the members under the ‘no’ category could be new members while the members in the ‘yes’ category never continued using the card after once.

```{r fig.dim=c(8,6), dpi=200}
dati1 <- na.omit(dati1)
ggplot(dati1) +
  aes(x = frequency13, fill = sesso) +
  geom_bar(position = "dodge") + theme_plotly() + 
  scale_fill_manual(values = pitaya)
```

Above shows the spend frequency range of customers against gender. No matter the age range, females always has higher spend frequency range compared to males.

# Variable Selection

## Data Partition 75/25 Split

```{r}

```


## Logistic Regression

```{r}
# Churn.Model <- glm(si2014 ~ ., family = "binomial",  dati1)
```

